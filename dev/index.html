<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cozy Voxel Farm â€” Cozy Style (Full Gameplay)</title>
<style>
  html,body{height:100%;margin:0;overflow:hidden;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto}
  #ui{position:fixed;left:12px;top:12px;z-index:60;background:rgba(255,255,255,0.94);padding:12px;border-radius:12px;box-shadow:0 8px 30px rgba(20,20,30,0.12)}
  #ui .row{display:flex;gap:8px;align-items:center}
  #hud{position:fixed;right:12px;top:12px;z-index:60;background:rgba(255,255,255,0.9);padding:10px;border-radius:10px}
  #market{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:120;background:linear-gradient(180deg,#fffef9,#fffbf0);border-radius:12px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,0.25);display:none;width:320px}
  #market h3{margin:0 0 8px 0}
  #market .item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-top:1px dashed #eee}
  button, .btn{background:#fff;border:1px solid #e2e2e2;padding:8px 10px;border-radius:8px;cursor:pointer}
  .msg{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(0,0,0,0.7);color:white;padding:8px 12px;border-radius:8px;font-family:monospace;z-index:70}
  .coin{color:#b8860b;font-weight:700}
</style>
</head>
<body>
<div id="ui">
  <div style="font-weight:700">Cozy Voxel Farm â€” Cozy Style</div>
  <div style="font-size:13px;margin-top:6px">WASD - ruch | Kliknij - pointer lock | Mysz - rozglÄ…danie | LPM - podlej/zbierz | PPM - sadÅº/usuÅ„</div>
  <div style="height:6px"></div>
  <div class="row">ðŸŒ¾ <span id="ui-seeds">0</span>  ðŸ’§ <span id="ui-water">0</span>  ðŸ”‹ <span id="ui-stamina">100</span>  ðŸ’° <span id="ui-coins">0</span></div>
  <div style="height:8px"></div>
  <div class="row"><button id="open-market">OtwÃ³rz Sklep</button><button id="upgrade-field">Rozszerz pole</button></div>
</div>
<div id="hud"></div>
<div id="market"><h3>Sklep farmy</h3>
  <div class="item"><div>10 nasion</div><div><button data-action="buySeeds">Koszt: <span class="coin">5</span></button></div></div>
  <div class="item"><div>Woda +5</div><div><button data-action="buyWater">Koszt: <span class="coin">3</span></button></div></div>
  <div class="item"><div>Nowe pole (odblokuj)</div><div><button data-action="buyField">Koszt: <span class="coin">20</span></button></div></div>
  <div style="height:10px"></div>
  <div style="text-align:right"><button id="close-market">Zamknij</button></div>
</div>
<div id="toast" class="msg" style="display:none"></div>
<script>
// Cozy Voxel Farm â€” full gameplay single-file
const THREE_CDN = 'https://unpkg.com/three@0.155.0/build/three.min.js';
function loadScript(url){return new Promise((res,reject)=>{const s=document.createElement('script');s.src=url;s.onload=res;s.onerror=reject;document.head.appendChild(s)})}

(async ()=>{
  await loadScript(THREE_CDN); const THREE=window.THREE;
  // scene
  const scene=new THREE.Scene();
  const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,1000);
  const renderer=new THREE.WebGLRenderer({antialias:true}); renderer.setSize(innerWidth,innerHeight); renderer.setPixelRatio(window.devicePixelRatio||1); document.body.appendChild(renderer.domElement);
  window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight)});

  // lighting
  const sun=new THREE.DirectionalLight(0xffffff,1); sun.position.set(5,10,2); sun.castShadow=true; scene.add(sun);
  const amb=new THREE.HemisphereLight(0x88bbff,0x664422,0.7); scene.add(amb);

  // procedural textures (pixel-ish)
  function hash(x,y){return Math.abs(Math.sin((x*12.9898+y*78.233)*43758.5453123))%1}
  function makeTexture(pix){const c=document.createElement('canvas');c.width=c.height=64;const g=c.getContext('2d');const id=g.createImageData(64,64);for(let y=0;y<64;y++)for(let x=0;x<64;x++){const i=(y*64+x)*4;const col=pix(x,y);id.data[i]=col[0];id.data[i+1]=col[1];id.data[i+2]=col[2];id.data[i+3]=255;}g.putImageData(id,0,0);const t=new THREE.CanvasTexture(c);t.magFilter=THREE.NearestFilter;t.minFilter=THREE.NearestMipmapNearestFilter;return t}
  const texGrass=makeTexture((x,y)=>[34,140+hash(x,y)*60,45+hash(x,y)*20]);
  const texDirt=makeTexture((x,y)=>{const v=90+hash(x,y)*40;return [v-10,v-30,v-30]});
  const texWater=makeTexture((x,y)=>{const v=120+hash(x,y)*80;return [30,80,v]});
  const texCrop=makeTexture((x,y)=>[200,60+hash(x,y)*100,80]);

  // world grid and map expansion system
  let MAP=24; const baseMAP=24; let blocks; function initBlocks(size){blocks=new Int8Array(size*size); for(let x=0;x<size;x++)for(let z=0;z<size;z++){const i=x+z*size; blocks[i]=1; if(x>9&&x<13&&z>3&&z<10)blocks[i]=3; if(x>4&&x<12&&z>8&&z<16)blocks[i]=2; }} initBlocks(MAP);

  const cubeGeo=new THREE.BoxGeometry(1,1,1);
  const mats={grass:new THREE.MeshLambertMaterial({map:texGrass}),dirt:new THREE.MeshLambertMaterial({map:texDirt}),water:new THREE.MeshLambertMaterial({map:texWater,transparent:true,opacity:0.9})};
  const worldGroup=new THREE.Group(); scene.add(worldGroup);
  function rebuildWorld(){ worldGroup.clear(); for(let x=0;x<MAP;x++)for(let z=0;z<MAP;z++){const i=x+z*MAP; const t=blocks[i]; if(!t) continue; const mat = t===1?mats.grass: t===2?mats.dirt: mats.water; const m=new THREE.Mesh(cubeGeo,mat); m.position.set(x-MAP/2+0.5,0.5,z-MAP/2+0.5); worldGroup.add(m);} }

  // crops (billboards)
  const crops={}; const cropGeo=new THREE.PlaneGeometry(0.9,0.9); const cropMat=new THREE.MeshLambertMaterial({map:texCrop,transparent:true,side:THREE.DoubleSide}); const cropGroup=new THREE.Group(); scene.add(cropGroup);
  function rebuildCrops(){ cropGroup.clear(); for(const k in crops){const [gx,gz]=k.split(',').map(Number);const c=crops[k]; const m=new THREE.Mesh(cropGeo,cropMat); m.position.set(gx-MAP/2+0.5, 0.9 + c.stage*0.12, gz-MAP/2+0.5); m.scale.setScalar(0.6 + c.stage*0.12); m.userData.key=k; cropGroup.add(m);} }

  // player
  const player={pos:new THREE.Vector3(0,1.6,8),yaw:0,pitch:0,seeds:8,water:5,stamina:100,coins:0}; camera.position.copy(player.pos);
  const keys={}; window.addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true); window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

  // pointer lock
  let locked=false; renderer.domElement.addEventListener('click',()=>{renderer.domElement.requestPointerLock()}); document.addEventListener('pointerlockchange',()=>locked=document.pointerLockElement===renderer.domElement);
  document.addEventListener('mousemove',e=>{ if(!locked) return; player.yaw -= e.movementX*0.0025; player.pitch -= e.movementY*0.0025; player.pitch=Math.max(-1.4,Math.min(1.4,player.pitch)); });

  // reach raycast
  const raycaster=new THREE.Raycaster(); function centerHit(){ raycaster.setFromCamera({x:0,y:0},camera); const hits=raycaster.intersectObjects(worldGroup.children); return hits.length?hits[0]:null }
  const REACH=3.2; function inReach(pt){return camera.position.distanceTo(pt)<=REACH}

  // interactions
  function toast(s){const t=document.getElementById('toast'); t.textContent=s; t.style.display='block'; clearTimeout(t._to); t._to=setTimeout(()=>t.style.display='none',1600)}

  function useAction(){ const hit=centerHit(); if(!hit) return; const obj=hit.object; if(!inReach(hit.point)){ toast('Za daleko'); return; } const gx=Math.round(obj.position.x - 0.5 + MAP/2); const gz=Math.round(obj.position.z - 0.5 + MAP/2); const key=gx+','+gz; const idx=gx+gz*MAP; if(blocks[idx]===3){ player.water++; playSound('sip'); toast('NabraÅ‚eÅ› wody'); updateUI(); return; } if(crops[key] && crops[key].stage>=4){ // harvest
      delete crops[key]; player.seeds += 2; player.coins += 4; spawnHarvestParticles(new THREE.Vector3(obj.position.x,obj.position.y+0.8,obj.position.z)); playSound('coin'); toast('Zebrano plon! +4 coin'); rebuildCrops(); updateUI(); return; }
    if(crops[key] && crops[key].watered && crops[key].stage<4){ toast('PodlaÅ‚eÅ› wczeÅ›niej, poczekaj'); return; }
    if(crops[key] && player.water>0){ crops[key].watered=true; player.water--; playSound('water'); toast('Podlano roÅ›linÄ™'); updateUI(); return; }
    if(blocks[idx]===1){ blocks[idx]=2; rebuildWorld(); playSound('till'); toast('Zorano ziemiÄ™'); return; } }

  function plantAction(){ const hit=centerHit(); if(!hit) return; const obj=hit.object; if(!inReach(hit.point)){ toast('Za daleko'); return; } const gx=Math.round(obj.position.x - 0.5 + MAP/2); const gz=Math.round(obj.position.z - 0.5 + MAP/2); const key=gx+','+gz; const idx=gx+gz*MAP; if(blocks[idx]===2 && player.seeds>0 && !crops[key]){ crops[key]={stage:0,watered:false,ticks:0}; player.seeds--; playSound('plant'); toast('Posadzono nasionko'); rebuildCrops(); updateUI(); return; } if(crops[key]){ delete crops[key]; rebuildCrops(); playSound('remove'); toast('UsuniÄ™to roÅ›linÄ™'); return; } }

  document.addEventListener('mousedown',e=>{ if(e.button===0) useAction(); if(e.button===2) plantAction(); }); document.addEventListener('contextmenu',e=>e.preventDefault());

  // growth + gentle animation (pulsing, shimmer for ready)
  setInterval(()=>{ for(const k in crops){ const c=crops[k]; if(c.watered){ c.ticks++; if(c.ticks>=3){ c.ticks=0; c.stage++; if(c.stage>4) c.stage=4; } c.watered=false } } rebuildCrops(); }, 2200);

  // simple particle system for harvest
  const particles=new THREE.Group(); scene.add(particles);
  function spawnHarvestParticles(pos){ for(let i=0;i<10;i++){ const s=new THREE.Mesh(new THREE.SphereGeometry(0.03,6,6), new THREE.MeshStandardMaterial({color:0xffd27f,emissive:0xffd27f})); s.position.copy(pos); s.userData.vel=new THREE.Vector3((Math.random()-0.5)*1,(Math.random()*0.6)+0.2,(Math.random()-0.5)*1); particles.add(s); } }

  // sound (WebAudio simple synths)
  const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  function playSound(name){ try{ const t=audioCtx.currentTime; if(name==='coin'){ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(880,t); g.gain.setValueAtTime(0.001,t); g.gain.exponentialRampToValueAtTime(0.03,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.3); o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+0.35);} else if(name==='water'){ const b=audioCtx.createOscillator(); const g=audioCtx.createGain(); b.type='triangle'; b.frequency.setValueAtTime(660,t); g.gain.setValueAtTime(0.001,t); g.gain.exponentialRampToValueAtTime(0.02,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.5); b.connect(g); g.connect(audioCtx.destination); b.start(t); b.stop(t+0.4);} else if(name==='till' || name==='plant'){ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='square'; o.frequency.value = name==='till'?220:440; g.gain.setValueAtTime(0.001,t); g.gain.exponentialRampToValueAtTime(0.02,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.4); o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+0.35);} else if(name==='sip'){ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(600,t); g.gain.setValueAtTime(0.001,t); g.gain.exponentialRampToValueAtTime(0.015,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.35); o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+0.3);} }catch(e){console.warn('audio',e)} }

  // UI
  const uiSeeds=document.getElementById('ui-seeds'); const uiWater=document.getElementById('ui-water'); const uiStam=document.getElementById('ui-stamina'); const uiCoins=document.getElementById('ui-coins'); const hud=document.getElementById('hud'); function updateUI(){ uiSeeds.textContent=player.seeds; uiWater.textContent=player.water; uiStam.textContent=Math.round(player.stamina); uiCoins.textContent=player.coins; hud.innerHTML=`<div>Reach: ${REACH.toFixed(1)}</div>` }
  updateUI();

  // market logic
  const market=document.getElementById('market'); document.getElementById('open-market').addEventListener('click',()=>{market.style.display='block'}); document.getElementById('close-market').addEventListener('click',()=>{market.style.display='none'});
  document.querySelectorAll('#market button[data-action]').forEach(b=>b.addEventListener('click',()=>{ const act=b.getAttribute('data-action'); if(act==='buySeeds'){ if(player.coins>=5){player.coins-=5;player.seeds+=10; toast('Kupiono 10 nasion'); playSound('coin'); updateUI(); } else toast('Za maÅ‚o coinÃ³w'); } if(act==='buyWater'){ if(player.coins>=3){player.coins-=3;player.water+=5; toast('Kupiono wodÄ™ +5'); playSound('coin'); updateUI(); } else toast('Za maÅ‚o coinÃ³w'); } if(act==='buyField'){ if(player.coins>=20){player.coins-=20; expandField(); toast('Odblokowano nowe pole'); playSound('coin'); updateUI(); } else toast('Za maÅ‚o coinÃ³w'); } }));

  // expand field / unlock new terrain (adds 6x6 around)
  function expandField(){ const oldMAP=MAP; MAP = MAP + 6; // create new blocks array
    const newBlocks=new Int8Array(MAP*MAP); for(let x=0;x<MAP;x++)for(let z=0;z<MAP;z++){ newBlocks[x+z*MAP]=0;} const offset = Math.floor((MAP-oldMAP)/2);
    // copy old
    for(let x=0;x<oldMAP;x++)for(let z=0;z<oldMAP;z++){ newBlocks[(x+offset)+ (z+offset)*MAP] = blocks[x+z*oldMAP]; }
    // fill new edges with grass
    for(let x=0;x<MAP;x++)for(let z=0;z<MAP;z++){ if(newBlocks[x+z*MAP]===0) newBlocks[x+z*MAP]=1; }
    blocks=newBlocks; rebuildWorld(); rebuildCrops(); }

  document.getElementById('upgrade-field').addEventListener('click',()=>{ const cost=12; if(player.coins>=cost){ player.coins-=cost; expandField(); toast('Rozszerzono pole (kupione)'); updateUI(); } else toast('Za maÅ‚o coinÃ³w'); });

  // save/load
  window.addEventListener('keydown',e=>{ if(e.key==='p'){ localStorage.setItem('cozy_save', JSON.stringify({MAP:MAP,blocks:Array.from(blocks),crops:crops,player:{x:player.pos.x,z:player.pos.z,seeds:player.seeds,water:player.water,coins:player.coins}})); toast('Zapisano'); } if(e.key==='l'){ const s=localStorage.getItem('cozy_save'); if(s){ const d=JSON.parse(s); MAP=d.MAP; initBlocks(MAP); for(let i=0;i<blocks.length;i++) blocks[i]=d.blocks[i]; Object.assign(crops,d.crops); player.pos.x=d.player.x; player.pos.z=d.player.z; player.seeds=d.player.seeds; player.water=d.player.water; player.coins=d.player.coins; rebuildWorld(); rebuildCrops(); updateUI(); toast('Wczytano'); } } });

  // rebuild helpers
  function rebuildCrops(){ cropGroup.clear(); for(const k in crops){ const [gx,gz]=k.split(',').map(Number); const c=crops[k]; const m=new THREE.Mesh(cropGeo,cropMat); m.position.set(gx-MAP/2+0.5, 0.9 + c.stage*0.12, gz-MAP/2+0.5); m.scale.setScalar(0.6 + c.stage*0.12); m.userData.key=k; cropGroup.add(m); } }
  function rebuildWorld(){ worldGroup.clear(); for(let x=0;x<MAP;x++)for(let z=0;z<MAP;z++){ const i=x+z*MAP; const t=blocks[i]; if(!t) continue; const mat = t===1?mats.grass: t===2?mats.dirt: mats.water; const m=new THREE.Mesh(cubeGeo,mat); m.position.set(x-MAP/2+0.5,0.5,z-MAP/2+0.5); worldGroup.add(m); } }
  rebuildWorld(); rebuildCrops();

  // animate loop
  let last=performance.now(); let bob=0; function animate(){ const now=performance.now(); const dt=(now-last)/1000; last=now;
    // movement
    const dir=new THREE.Vector3(); if(keys['w'])dir.z-=1; if(keys['s'])dir.z+=1; if(keys['a'])dir.x-=1; if(keys['d'])dir.x+=1; if(dir.lengthSq()>0) dir.normalize(); const speed=3.6; const forward=new THREE.Vector3(Math.sin(player.yaw),0,Math.cos(player.yaw)); const right=new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), forward);
    const move=new THREE.Vector3(); move.addScaledVector(forward, dir.z); move.addScaledVector(right, dir.x); player.pos.addScaledVector(move, speed*dt);
    // camera follow & bob
    const moving = dir.lengthSq()>0; bob += (moving?dt*8:dt*1); const bobOffset = moving?Math.sin(bob)*0.04:0; const targetPos = new THREE.Vector3(player.pos.x, player.pos.y + bobOffset, player.pos.z); camera.position.lerp(targetPos, 0.18); camera.rotation.order='YXZ'; camera.rotation.y=player.yaw; camera.rotation.x=player.pitch;
    // crops face camera & shimmer effect when ready
    cropGroup.children.forEach(m=>{ m.lookAt(new THREE.Vector3(camera.position.x, m.position.y, camera.position.z)); const c = crops[m.userData.key]; if(c){ const ready = c.stage>=4; if(ready){ m.material.emissive = new THREE.Color(0x88ff77); m.material.emissiveIntensity = 0.2 + Math.sin(now/250)*0.1; } else { m.material.emissiveIntensity = 0; } } });
    // particle update
    particles.children.forEach(p=>{ p.position.addScaledVector(p.userData.vel, dt); p.userData.vel.y -= 1.2*dt; p.scale.multiplyScalar(0.99); }); while(particles.children.length>300) particles.remove(particles.children[0]);
    // day-night
    const dayT=(Date.now()/1000/12)%1; sun.position.set(Math.sin(dayT*Math.PI*2)*12, Math.cos(dayT*Math.PI*2)*12, 5); sun.intensity = Math.max(0.25, Math.cos(dayT*Math.PI*2)*1.05);
    renderer.render(scene,camera); requestAnimationFrame(animate); }
  animate();

  // small startup message
  function showToast(t){ toast(t); }
  showToast('Witaj! Kliknij aby zablokowaÄ‡ mysz. PPM sadzi, LPM podlewa/zbiera. OdwiedÅº sklep (open) by kupiÄ‡ nasiona i pola.');
})();
</script>
</body>
</html>
